<div class="card">
    <p-table [value]="categorias" dataKey="id" [expandedRowKeys]="expandedRows" class="custom-table" [paginator]="true" [rows]="10">
        <ng-template pTemplate="caption">
            <div class="flex flex-wrap justify-content-end gap-2">
                <p-button label="Expandir todo" icon="pi pi-plus" text (onClick)="expandAll()"></p-button>
                <p-button label="Cerrar todo" icon="pi pi-minus" text (onClick)="collapseAll()"></p-button>
            </div>
        </ng-template>
        
        <ng-template pTemplate="header">
            <tr>
                <th style="width: 5rem"></th>
                <th pSortableColumn="nombre" pFilterField="filterCategory">
                    Categoria
                    <p-sortIcon field="nombre"></p-sortIcon>
                    <p-columnFilter field="filterCategory" matchMode="contains" placeholder="Buscar categoría" (ngModelChange)="onFilter()"></p-columnFilter>
                </th>
                <th pSortableColumn="cantidadTotal" pFilterField="filterCantidadTotal">
                    Cantidad TOTAL
                    <p-sortIcon field="cantidadTotal"></p-sortIcon>
                    <p-columnFilter field="filterCantidadTotal" type="numeric" placeholder="Filtrar cantidad" (ngModelChange)="onFilter()"></p-columnFilter>
                </th>
                <th pSortableColumn="productosPorVencer" pFilterField="filterProductosPorVencer">
                    Productos por vencer
                    <p-sortIcon field="productosPorVencer"></p-sortIcon>
                    <p-columnFilter field="filterProductosPorVencer" type="numeric" placeholder="Filtrar por vencer" (ngModelChange)="onFilter()"></p-columnFilter>
                </th>
                
            </tr>
        </ng-template>
        
        <ng-template pTemplate="body" let-categoria let-expanded="expanded">
            <tr [ngClass]="{ 'expanded-row': expanded, 'custom-row-color': calcularCantidadTotal(categoria) > 100 }">
                <td>
                    <p-button type="button" pRipple [pRowToggler]="categoria" [text]="true" [rounded]="true" [plain]="true"
                        [icon]="expanded ? 'pi pi-angle-down' : 'pi pi-angle-right'"></p-button>
                </td>
                <td>{{ categoria.nombre }}</td>
                <td>{{ calcularCantidadTotal(categoria) }}</td>
                <td>
                    <span [ngClass]="{'highlight-number': calcularCantidadPorVencer(categoria) > 0,'highlight-number-zero': calcularCantidadPorVencer(categoria) === 0}">
                    {{ calcularCantidadPorVencer(categoria) }}</span> Producto(s) próximos a vencer
                </td>
            </tr>
        </ng-template>
        
        <ng-template pTemplate="rowexpansion" let-categoria>
            <tr>
                <td colspan="5" class="expanded-body">
                    <div class="p-3 expanded-content">
                        <p-table [value]="categoria.tandas" dataKey="id">
                            <ng-template pTemplate="header">
                                <tr>
                                    <th pSortableColumn="producto">Producto <p-sortIcon field="producto"></p-sortIcon></th>
                                    <th pSortableColumn="cantidadActual">Cantidad <p-sortIcon field="cantidadActual"></p-sortIcon></th>
                                    <th pSortableColumn="fechaVencimiento">Fecha de expiración <p-sortIcon field="fechaVencimiento"></p-sortIcon></th>
                                    <th>Bodega</th>
                                    <th>Ubicación</th>
                                </tr>
                            </ng-template>
                            <ng-template pTemplate="body" let-tanda>
                                <tr [ngClass]="{ 'tanda-warning': tanda.cantidadActual < 50 }">
                                    <td>{{ tanda.producto }}</td>
                                    <td>{{ tanda.cantidadActual }}</td>
                                    <td>{{ tanda.fechaVencimiento | date:'dd-MM-yyyy' }}</td>
                                    <td>{{ tanda.bodega }}</td>
                                    <td>{{ tanda.ubicacion }}</td>
                                </tr>
                            </ng-template>
                        </p-table>
                    </div>
                </td>
            </tr>
        </ng-template>
    </p-table>
</div>
